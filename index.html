<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="robots" content="index, follow">
<meta name="description" content="AllergoZyme Label r√©f√©rence les √©tablissements s√©curis√©s pour les allergiques. Carte mondiale et informations v√©rifi√©es.">
<title>AllergoZymeLabel ‚Äî Carte mondiale</title>
<link rel="icon" type="image/png" href="logo2.png"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://fcronugfxklwygnchuuu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<style>
:root{--gold:#c9a227;--white:#fff;--black:#0e0e0e;--shadow-md:0 8px 22px rgba(0,0,0,.16)}
html,body{height:100%;margin:0;font-family:"Inter",sans-serif;background:#fff}
#map{position:absolute;inset:0}
.logo{position:absolute;top:14px;left:50%;transform:translateX(-50%);z-index:1200}
.logo img{height:56px;filter:drop-shadow(0 5px 8px rgba(0,0,0,.12))}
.fab{position:absolute;right:16px;bottom:110px;z-index:1200;background:var(--gold);color:#fff;border:none;padding:12px 18px;border-radius:999px;box-shadow:var(--shadow-md);cursor:pointer;font-weight:800;font-size:15px}
.bottom-filters{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;display:flex;gap:10px;background:rgba(255,255,255,.9);border-radius:18px;padding:8px 12px;box-shadow:var(--shadow-md);backdrop-filter:blur(6px);z-index:1200}
.bottom-filters button{border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:800;font-size:13px;padding:7px 12px;border-radius:999px;cursor:pointer}
.bottom-filters button.active,.bottom-filters button:hover{background:var(--gold);color:#fff}
.place-overlay{position:absolute;left:50%;bottom:100px;transform:translateX(-50%);z-index:1300;display:none;width:min(92vw,560px)}
.place-overlay__media{position:relative;width:100%;height:240px;border-radius:18px;overflow:hidden;background:#eee center/cover no-repeat}
.place-overlay__badge{position:absolute;top:10px;left:10px;background:#fff;color:var(--gold);border:1px solid var(--gold);font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px}
.place-overlay__info{position:absolute;right:10px;left:10px;bottom:10px;display:flex;justify-content:space-between;gap:10px;align-items:flex-end}
.info{background:rgba(255,255,255,.92);border-radius:14px;padding:10px 12px}
.info b{color:var(--gold);font-size:15px}
.votes{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.92);padding:6px 10px;border-radius:12px}
.vote-btn{border:none;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:800}
.vote-btn.up{color:#2e7d32}
.vote-btn.down{color:#c62828}
.marker-icon{width:52px;height:52px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid var(--gold)}
.marker-icon img{width:30px;height:30px}
</style>
</head>
<body>
<div id="map"></div>
<div class="logo"><img src="logo.png" alt="AllergoZyme"/></div>
<button class="fab" id="locateBtn">üìç Localiser</button>

<!-- Overlay -->
<div class="place-overlay" id="placeOverlay">
  <div class="place-overlay__media" id="ovMedia">
    <div class="place-overlay__badge" id="ovType">Type</div>
    <div class="place-overlay__info">
      <div class="info">
        <b id="ovName">Nom</b>
        <div id="ovAddr"></div>
        <div id="ovComment"></div>
      </div>
      <div class="votes">
        <button class="vote-btn up" id="ovUpBtn">üëç <span id="ovUp">0</span></button>
        <button class="vote-btn down" id="ovDownBtn">üëé <span id="ovDown">0</span></button>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="bottom-filters" id="bottomFilters">
  <button data-type="all" class="active">Tous</button>
  <button data-type="restaurant">Restaurant</button>
  <button data-type="boulangerie">Boulangerie</button>
  <button data-type="snack">Snack</button>
  <button data-type="bar">Bar</button>
  <button data-type="autre">Autre</button>
</div>

<script>
let map,places=[],markers=[],typeFilter="all",currentOverlayId=null;
function initMap(){
  map=L.map("map",{
    worldCopyJump:true,
    minZoom:2,
    maxZoom:19,
    maxBounds:[[-85,-180],[85,180]],
    maxBoundsViscosity:1.0
  }).setView([20,0],2);
  L.esri.basemapLayer("Imagery").addTo(map);
  L.esri.basemapLayer("ImageryLabels").addTo(map);
}
function buildMarker(p){
  const icon=L.divIcon({html:`<div class="marker-icon"><img src="logo.png"/></div>`,iconSize:[52,52],className:""});
  const m=L.marker([p.lat,p.lng],{icon}).addTo(map);
  m.on("click",()=>openOverlay(p));
  markers.push(m);
}
function clearMarkers(){markers.forEach(m=>map.removeLayer(m));markers=[];}
function render(list){clearMarkers();(list||[]).forEach(p=>buildMarker(p));}
function openOverlay(p){
  currentOverlayId=p.id;
  document.getElementById("ovMedia").style.backgroundImage=`url('${p.photos?.[0]||"logo.png"}')`;
  document.getElementById("ovType").textContent=p.type||"Autre";
  document.getElementById("ovName").textContent=p.nom||"";
  document.getElementById("ovAddr").textContent=p.adresse||"";
  document.getElementById("ovComment").textContent=p.commentaire||"";
  document.getElementById("placeOverlay").style.display="block";
}
document.getElementById("locateBtn").addEventListener("click",()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude,pos.coords.longitude],14);
    });
  }
});
document.querySelectorAll("#bottomFilters button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("#bottomFilters button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    typeFilter=btn.dataset.type;
    const filtered=typeFilter==="all"?places:places.filter(p=>(p.type||"").toLowerCase()===typeFilter);
    render(filtered);
  });
});
initMap();
(async()=>{
  const {data}=await supabase.from("places").select("*");
  places=data||[];
  render(places);
})();
</script>
</body>
</html>
