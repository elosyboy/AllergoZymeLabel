<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AllergoZymeLabel ‚Äî Carte mondiale</title>

.bottom-filters{
  position:fixed;                     /* coll√© √† l‚Äô√©cran, pas √† la carte */
  left:50%;
  bottom:0;                            /* tout en bas */
  transform:translateX(-50%);
  background:rgba(255,255,255,0.92);
  border-radius:20px;
  padding:10px 14px;
  box-shadow:var(--shadow-md);
  display:flex;
  flex-wrap:wrap;                      /* si l‚Äô√©cran est trop √©troit, passe sur 2 lignes */
  gap:10px;
  z-index:1200;
  backdrop-filter:blur(6px);
}

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet"></script>

<style>
:root {
  --gold:#c9a227; --white:#fff; --gray:#f7f7f7; --black:#111;
  --shadow-sm:0 3px 10px rgba(0,0,0,0.08);
  --shadow-md:0 6px 18px rgba(0,0,0,0.15);
  --shadow-lg:0 14px 30px rgba(0,0,0,0.18);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Segoe UI', Roboto, Arial, sans-serif;
  height:100vh; display:flex; background:var(--white); color:var(--black);
}

/* ============ SIDEBAR ============ */
.sidebar{
  width:360px; background:var(--gray);
  border-right:1px solid #e5e5e5; display:flex; flex-direction:column;
  z-index:900; position:relative;
}
.sidebar-head{
  display:flex; align-items:center; gap:10px;
  padding:12px 14px; border-bottom:1px solid #e8e8e8;
}
.sidebar-head h2{
  font-size:18px; font-weight:900; color:var(--gold); margin-right:auto;
}
.pill{
  border:1px solid var(--gold); color:var(--gold); background:#fff;
  padding:6px 12px; border-radius:999px; cursor:pointer; font-size:13px; font-weight:800;
  transition:.2s;
}
.pill:hover,.pill.on{ background:var(--gold); color:#fff; }
.places-list{ flex:1; overflow-y:auto; padding:14px; }

/* Card style (image fond + infos en bas √† droite) */
.card{
  position:relative; border-radius:16px; overflow:hidden;
  background:#fff; box-shadow:var(--shadow-sm); margin-bottom:14px;
  transition:transform .2s, box-shadow .2s; cursor:pointer; min-height:190px;
}
.card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-md); }
.card__media{
  position:absolute; inset:0; background:#ddd center/cover no-repeat;
  filter:saturate(1.05) contrast(1.02);
}
.card__overlay{
  position:absolute; right:10px; bottom:10px; left:10px;
  display:flex; justify-content:space-between; gap:10px; align-items:flex-end;
}
.tag{
  position:absolute; top:10px; left:10px;
  background:rgba(255,255,255,0.92); color:var(--gold);
  border:1px solid var(--gold); font-size:12px; font-weight:800;
  padding:6px 10px; border-radius:999px; backdrop-filter:blur(6px);
  box-shadow:var(--shadow-sm);
}
.info{
  background:rgba(255,255,255,0.92); backdrop-filter:blur(6px);
  border:1px solid #eee; border-radius:14px; padding:10px 12px; box-shadow:var(--shadow-sm);
  max-width:78%;
}
.info b{ color:var(--gold); font-size:15px; }
.info .addr{ font-size:12px; color:#444; margin:2px 0 4px; }
.info .comment{ font-size:13px; color:#222; }
.votes{
  display:flex; gap:8px; align-items:center;
  background:rgba(255,255,255,0.92); border:1px solid #eee;
  padding:8px 10px; border-radius:12px; box-shadow:var(--shadow-sm);
}
.vote-btn{
  display:flex; align-items:center; gap:6px; font-size:13px; font-weight:800;
  border:none; cursor:pointer; border-radius:999px; padding:6px 10px;
  background:#fff; color:#333; border:1px solid #ddd; transition:.15s;
}
.vote-btn:hover{ box-shadow:var(--shadow-sm); transform:translateY(-1px); }
.vote-btn.up{ color:#2e7d32; border-color:#cde7cf; }
.vote-btn.down{ color:#c62828; border-color:#f3cccc; }

/* ============ MAP ============ */
#map{ flex:1; height:100vh; position:relative; z-index:100; }

/* ============ FLOATING UI ============ */
.logo{
  position:absolute; top:16px; left:50%; transform:translateX(-50%);
  z-index:1200; user-select:none; cursor:pointer;
}
.logo img{ height:60px; filter:drop-shadow(0 5px 8px rgba(0,0,0,.12)); }

.search-area{
  position:absolute; top:16px; right:16px; z-index:1200;
  display:flex; gap:8px; align-items:center;
  background:rgba(255,255,255,0.92); padding:8px 14px;
  border-radius:999px; box-shadow:var(--shadow-md); backdrop-filter:blur(6px);
}
.search-area input{
  padding:8px 14px; border:none; outline:none; border-radius:999px;
  background:#f0f0f0; min-width:260px; font-size:14px;
}
.search-area button{
  padding:8px 16px; border:none; border-radius:999px;
  background:var(--gold); color:#fff; font-weight:800; cursor:pointer;
}
.search-area button:hover{ background:#b18e1e; }

.fab{
  position:absolute; bottom:90px; right:20px; z-index:1200;
  background:var(--gold); color:#fff; border:none; padding:12px 18px;
  border-radius:999px; box-shadow:var(--shadow-md);
  cursor:pointer; font-weight:800; font-size:15px;
}
.fab:hover{ background:#b18e1e; }

/* Filtres bas carte */
.bottom-filters{
  position:absolute; bottom:70px; left:50%; transform:translateX(-50%);
  background:rgba(255,255,255,0.92); border-radius:20px; padding:10px 14px;
  box-shadow:var(--shadow-md); display:flex; gap:10px; z-index:1200; backdrop-filter:blur(6px);
}
.bottom-filters button{
  border:1px solid var(--gold); background:transparent; color:var(--gold);
  font-weight:800; font-size:14px; padding:8px 14px; border-radius:999px;
  cursor:pointer; transition:.2s;
}
.bottom-filters button:hover, .bottom-filters button.active{ background:var(--gold); color:#fff; }

/* ============ OVERLAY (popup premium) ============ */
.place-overlay{
  position:absolute; bottom:120px; right:20px; z-index:1300; width: min(520px, 86vw);
  border-radius:18px; overflow:hidden; box-shadow:var(--shadow-lg);
  display:none;
}
.place-overlay.show{ display:block; }
.place-overlay__media{
  position:relative; height:280px; background:#ddd center/cover no-repeat;
}
.place-overlay__badge{
  position:absolute; top:12px; left:12px;
  background:rgba(255,255,255,0.92); color:var(--gold);
  border:1px solid var(--gold); font-weight:900; font-size:12px;
  padding:6px 10px; border-radius:999px; backdrop-filter:blur(6px);
}
.place-overlay__info{
  position:absolute; bottom:12px; right:12px; left:12px;
  display:flex; justify-content:space-between; gap:10px; align-items:flex-end;
}
.place-overlay .info{ max-width:75%; }
.place-overlay .votes{ background:rgba(255,255,255,0.92); }

/* ============ FOOTER CONTACT ============ */
footer{
  position:fixed; left:0; right:0; bottom:0; z-index:1100;
  background:#fff; border-top:1px solid #eee; padding:10px 16px;
  display:flex; justify-content:center; align-items:center;
}
footer .contact{
  color:var(--gold); font-weight:900; letter-spacing:.2px; font-size:14px;
  text-align:center;
}

/* ============ MARKER ICON ============ */
.marker-icon{
  width:52px;height:52px;background:#fff;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--gold);
  box-shadow:0 6px 16px rgba(0,0,0,0.20);
}
.marker-icon img{ width:30px;height:30px; }

/* Scrollbar fine */
.places-list::-webkit-scrollbar{ width:10px; }
.places-list::-webkit-scrollbar-thumb{ background:#d8d8d8; border-radius:8px; }
.places-list::-webkit-scrollbar-track{ background:transparent; }
@media (max-width: 1100px){
  .sidebar{ width:320px; }
  .place-overlay__media{ height:240px; }
}
@media (max-width: 860px){
  .sidebar{ display:none; }
  .place-overlay{ right:50%; transform:translateX(50%); width:min(95vw,560px); }
  .bottom-filters{ bottom:82px; }
}
/* ‚úÖ Ajoute ici (‚âà lignes 187-188) */
html,body{overflow-x:hidden;}    /* supprime la bande blanche lat√©rale */
footer{margin-bottom:60px;}      /* espace sous les boutons pour √©viter qu‚Äôils ne chevauchent le footer */

</style>
</head>
<body>

<!-- ====== SIDEBAR ====== -->
<aside class="sidebar">
  <div class="sidebar-head">
    <h2>√âtablissements</h2>
    <button class="pill" id="top20Toggle">Top 20</button>
  </div>
  <div class="places-list" id="placesList">
    <p style="font-size:14px; color:#666;">Aucun √©tablissement labellis√©.</p>
  </div>
</aside>

<!-- ====== MAP ====== -->
<div id="map"></div>

<!-- ====== FLOATING UI ====== -->
<div class="logo" id="logoBtn" title="Voir un √©tablissement mis en avant">
  <img src="logo.png" alt="AllergoZyme">
</div>

<form class="search-area" id="searchForm" autocomplete="off">
  <input id="q" type="search" placeholder="Rechercher‚Ä¶ (nom, ville, d√©partement, pays, commentaire)" />
  <button type="submit">OK</button>
</form>

<button class="fab" id="locateBtn">üìç Localiser</button>

<!-- Filtres bas carte -->
<div class="bottom-filters" id="bottomFilters">
  <button data-type="all" class="active">Tous</button>
  <button data-type="restaurant">Restaurant</button>
  <button data-type="boulangerie">Boulangerie</button>
  <button data-type="snack">Snack</button>
  <button data-type="bar">Bar</button>
  <button data-type="autre">Autre</button>
</div>

<!-- ====== OVERLAY (POPUP PREMIUM) ====== -->
<div class="place-overlay" id="placeOverlay" aria-live="polite">
  <div class="place-overlay__media" id="ovMedia">
    <div class="place-overlay__badge" id="ovType">Type</div>
    <div class="place-overlay__info">
      <div class="info">
        <b id="ovName">Nom</b>
        <div class="addr" id="ovAddr">Adresse</div>
        <div class="comment" id="ovComment">Commentaire</div>
      </div>
      <div class="votes">
        <button class="vote-btn up" id="ovUpBtn">üëç <span id="ovUp">0</span></button>
        <button class="vote-btn down" id="ovDownBtn">üëé <span id="ovDown">0</span></button>
      </div>
    </div>
  </div>
</div>

<!-- ====== FOOTER CONTACT ====== -->
<footer>
  <div class="contact">Pour nous contacter : AllergoZyme ‚Äî Label &amp; certification. Ensemble, s√©curisons vos assiettes.</div>
</footer>

<script>
/* ========= DONN√âES ========= */
const STORAGE_KEY = "allergozyme_places_v3"; // rempli via admin.html
let places = [];
try { places = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { places = []; }

/* Votes persistants (s√©par√©s) */
const VOTES_KEY = "allergozyme_votes_v1";
let votes = {};
try { votes = JSON.parse(localStorage.getItem(VOTES_KEY)) || {}; } catch { votes = {}; }
const getVotes = (id)=> votes[id] || { up:0, down:0 };
const setVotes = (id, up, down) => {
  votes[id] = { up, down };
  localStorage.setItem(VOTES_KEY, JSON.stringify(votes));
};
/* Emp√™cher plusieurs votes par utilisateur */
const USER_VOTES_KEY = "allergozyme_user_votes_v1";
let userVotes = {};
try { userVotes = JSON.parse(localStorage.getItem(USER_VOTES_KEY)) || {}; }
catch { userVotes = {}; }

function hasUserVoted(id){
  return !!userVotes[id];
}
function markUserVoted(id, type){
  userVotes[id] = type; // 'up' ou 'down'
  localStorage.setItem(USER_VOTES_KEY, JSON.stringify(userVotes));
}


/* ========= CARTE ========= */
const map = L.map("map", { zoomControl:true }).setView([20,0],2);
L.esri.basemapLayer("Imagery").addTo(map);
L.esri.basemapLayer("ImageryLabels").addTo(map);

/* Ic√¥ne circulaire logo AllergoZyme */
const markerIcon = L.divIcon({
  html:`<div class="marker-icon"><img src="logo.png" alt=""></div>`,
  iconSize:[52,52], className:""
});

/* ========= √âTAT UI ========= */
let markers = [];
let showTop20Only = false;
let typeFilter = "all";
let currentOverlayId = null;

/* ========= UTILS ========= */
const escapeHTML = (s) => (s ?? "").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");
const getTypeLabel = (t) => {
  const x = (t||"").toLowerCase();
  if (!x) return "Autre";
  return x.charAt(0).toUpperCase() + x.slice(1);
}
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }

/* ========= OVERLAY (POPUP PREMIUM) ========= */
const overlayEl = document.getElementById("placeOverlay");
const ovMedia = document.getElementById("ovMedia");
const ovType = document.getElementById("ovType");
const ovName = document.getElementById("ovName");
const ovAddr = document.getElementById("ovAddr");
const ovComment = document.getElementById("ovComment");
const ovUp = document.getElementById("ovUp");
const ovDown = document.getElementById("ovDown");
const ovUpBtn = document.getElementById("ovUpBtn");
const ovDownBtn = document.getElementById("ovDownBtn");

function openOverlay(p){
  currentOverlayId = p.id;
  const bg = p.photos && p.photos[0] ? `url('${p.photos[0]}')` : `url('logo.png')`;
  ovMedia.style.backgroundImage = bg;
  ovType.textContent = getTypeLabel(p.type || "Autre");
  ovName.textContent = p.nom || "√âtablissement";
  const addressLine = [p.adresse, p.ville, p.cp, p.pays].filter(Boolean).join(" ‚Äî ");
  ovAddr.textContent = addressLine || "";
  ovComment.textContent = p.commentaire || "";
  const { up, down } = getVotes(p.id);
  ovUp.textContent = up;
  ovDown.textContent = down;
  overlayEl.classList.add("show");
}

function closeOverlay(){ overlayEl.classList.remove("show"); currentOverlayId = null; }

/* Fermer overlay si on clique sur l'ext√©rieur (zone carte) */
map.on("click", ()=> { closeOverlay(); });

/* ========= RENDU ========= */
function createCardElement(p){
  const wrap = document.createElement("div");
  wrap.className = "card";
  const bg = p.photos && p.photos[0] ? `background-image:url('${p.photos[0]}')` : `background-image:url('logo.png')`;
  const { up, down } = getVotes(p.id);
  const addressLine = [p.adresse, p.ville, p.cp, p.pays].filter(Boolean).join(" ‚Äî ");

  wrap.innerHTML = `
    <div class="card__media" style="${bg}"></div>
    <div class="tag">${escapeHTML(getTypeLabel(p.type))}${p.top20 ? " ¬∑ Top 20" : ""}</div>
    <div class="card__overlay">
      <div class="info">
        <b>${escapeHTML(p.nom || "")}</b>
        <div class="addr">${escapeHTML(addressLine || "")}</div>
        <div class="comment">${escapeHTML(p.commentaire || "")}</div>
      </div>
      <div class="votes">
        <button class="vote-btn up">üëç <span>${up}</span></button>
        <button class="vote-btn down">üëé <span>${down}</span></button>
      </div>
    </div>
  `;

  // interactions
  wrap.addEventListener("click", (e)=>{
    // √©viter que le clic sur vote ferme/ouvre autre chose
    const isVote = e.target.closest(".vote-btn");
    if (isVote) return;
    map.setView([p.lat, p.lng], 16);
    openOverlay(p);
  });

  const upBtn = wrap.querySelector(".vote-btn.up");
  const downBtn = wrap.querySelector(".vote-btn.down");
 upBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  if (hasUserVoted(p.id)) return;        // ‚úÖ Bloque si d√©j√† vot√©
  const v = getVotes(p.id);
  v.up += 1; setVotes(p.id, v.up, v.down);
  markUserVoted(p.id,'up');              // ‚úÖ M√©morise le vote
  upBtn.querySelector("span").textContent = v.up;
  if (currentOverlayId === p.id) ovUp.textContent = v.up;
});
downBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  if (hasUserVoted(p.id)) return;        // ‚úÖ Bloque si d√©j√† vot√©
  const v = getVotes(p.id);
  v.down += 1; setVotes(p.id, v.up, v.down);
  markUserVoted(p.id,'down');            // ‚úÖ M√©morise le vote
  downBtn.querySelector("span").textContent = v.down;
  if (currentOverlayId === p.id) ovDown.textContent = v.down;
});
  return wrap;
}

function render(list){
  clearMarkers();
  const sidebar = document.getElementById("placesList");
  sidebar.innerHTML = "";

  const visible = (list || []).filter(p => p.show);
  let filtered = visible;
  if (showTop20Only) filtered = filtered.filter(p=>p.top20);
  if (typeFilter !== "all") filtered = filtered.filter(p => (p.type||"").toLowerCase() === typeFilter);

  if (!filtered.length){
    sidebar.innerHTML = `<p style="font-size:14px; color:#666;">Aucun √©tablissement labellis√©.</p>`;
    return;
  }

  // top20 d‚Äôabord
  const top = filtered.filter(p=>p.top20);
  const others = filtered.filter(p=>!p.top20);

  function addMarkerAndCard(p){
    const m = L.marker([p.lat, p.lng], { icon: markerIcon }).addTo(map);
    m.on("click", ()=> openOverlay(p));
    markers.push(m);
    sidebar.appendChild(createCardElement(p));
  }

  top.forEach(addMarkerAndCard);
  others.forEach(addMarkerAndCard);
}

/* ========= INIT RENDU ========= */
render(places);

/* ========= RECHERCHE ========= */
document.getElementById("searchForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const q = document.getElementById("q").value.trim().toLowerCase();
  if (!q){ render(places); return; }
  const filtered = places.filter(p=>{
    const hay = [
      p.nom, p.commentaire, p.ville, p.departement, p.pays, p.adresse, p.type
    ].map(v => (v||"").toString().toLowerCase()).join(" ");
    return hay.includes(q);
  });
  render(filtered);
});

/* ========= TOP 20 TOGGLE ========= */
document.getElementById("top20Toggle").addEventListener("click", ()=>{
  showTop20Only = !showTop20Only;
  document.getElementById("top20Toggle").classList.toggle("on", showTop20Only);
  render(places);
});

/* ========= LOCALISATION ========= */
function haversine(lat1,lon1,lat2,lon2){
  const toRad=v=>(v*Math.PI)/180; const R=6371;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
document.getElementById("locateBtn").addEventListener("click",()=>{
  if(!navigator.geolocation){ alert("G√©olocalisation non support√©e."); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const user={ lat:pos.coords.latitude, lng:pos.coords.longitude };
    map.setView([user.lat,user.lng],14);
    L.circle([user.lat,user.lng],{
      radius:250, color: "#c9a227", fillColor:"#c9a227", fillOpacity:0.25
    }).addTo(map);

    // Focus Top20 proches (<=30km) si dispo
    const nearbyTop = places.filter(p=>p.show && p.top20)
      .map(p=>({p, d: haversine(user.lat,user.lng,p.lat,p.lng)}))
      .filter(x=>x.d<=30).sort((a,b)=>a.d-b.d).map(x=>x.p);

    if (nearbyTop.length){
      showTop20Only = true;
      document.getElementById("top20Toggle").classList.add("on");
      render(nearbyTop);
    }else{
      showTop20Only = false;
      document.getElementById("top20Toggle").classList.remove("on");
      render(places);
    }
  },()=>{ alert("Impossible de r√©cup√©rer la position."); },
  { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
});

/* ========= FILTRES TYPE ========= */
document.querySelectorAll("#bottomFilters button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("#bottomFilters button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    typeFilter = btn.dataset.type;
    render(places);
  });
});

/* ========= LOGO CLICK ‚Üí ouvrir une fiche mise en avant ========= */
document.getElementById("logoBtn").addEventListener("click", ()=>{
  // priorit√©: top20 selon filtre -> sinon premier visible
  const visible = places.filter(p=>p.show);
  let candidate = null;
  const filtered = typeFilter==="all" ? visible : visible.filter(p=>(p.type||"").toLowerCase()===typeFilter);
  const top = filtered.filter(p=>p.top20);
  if (top.length) candidate = top[0];
  else if (filtered.length) candidate = filtered[0];
  else if (visible.length) candidate = visible[0];

  if (candidate){
    map.setView([candidate.lat, candidate.lng], 16);
    openOverlay(candidate);
  }
});

/* ========= VOTE depuis l‚Äôoverlay ========= */
ovUpBtn.addEventListener("click", ()=>{
  if (currentOverlayId==null || hasUserVoted(currentOverlayId)) return; // ‚úÖ Bloque si d√©j√† vot√©
  const v = getVotes(currentOverlayId);
  v.up++; setVotes(currentOverlayId, v.up, v.down);
  markUserVoted(currentOverlayId,'up');                                 // ‚úÖ M√©morise
  ovUp.textContent = v.up;
  render(places);
  const p = places.find(x=>x.id===currentOverlayId);
  if (p) openOverlay(p);
});
ovDownBtn.addEventListener("click", ()=>{
  if (currentOverlayId==null || hasUserVoted(currentOverlayId)) return; // ‚úÖ Bloque si d√©j√† vot√©
  const v = getVotes(currentOverlayId);
  v.down++; setVotes(currentOverlayId, v.up, v.down);
  markUserVoted(currentOverlayId,'down');                               // ‚úÖ M√©morise
  ovDown.textContent = v.down;
  render(places);
  const p = places.find(x=>x.id===currentOverlayId);
  if (p) openOverlay(p);
});
</script>
</body>
</html>
