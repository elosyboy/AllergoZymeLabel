<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AllergoZymeLabel ‚Äî Carte mondiale</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet"></script>

<style>
:root {
  --gold:#c9a227; --white:#fff; --gray:#f7f7f7; --black:#111;
  --shadow:0 6px 18px rgba(0,0,0,0.15);
}
*{margin:0;padding:0;box-sizing:border-box;}
body {
  font-family:'Segoe UI',Roboto,Arial,sans-serif;
  height:100vh; display:flex;
  background:var(--white); color:var(--black);
}

/* Sidebar fixe */
.sidebar {
  width:360px; background:var(--gray);
  border-right:1px solid #ddd;
  display:flex; flex-direction:column;
  z-index:900; position:relative;
}
.sidebar-head {
  display:flex; justify-content:flex-start; align-items:center;
  padding:12px; border-bottom:1px solid #ddd;
}
.sidebar-head h2 {
  font-size:18px; font-weight:800; color:var(--gold);
  margin-right:auto;
}
.pill {
  border:1px solid var(--gold); color:var(--gold); background:#fff;
  padding:6px 12px; border-radius:999px; cursor:pointer; font-size:13px; font-weight:700;
  transition:all .2s;
}
.pill:hover,
.pill.on { background:var(--gold); color:#fff; }

.places-list {
  flex:1; overflow-y:auto; padding:14px;
}
.place-item {
  background:#fff; border-radius:16px; padding:14px;
  margin-bottom:14px; box-shadow:0 3px 10px rgba(0,0,0,0.08);
  cursor:pointer; transition:transform .2s, box-shadow .2s;
}
.place-item:hover { transform:translateY(-2px); box-shadow:0 4px 14px rgba(0,0,0,0.12); }
.place-item img { width:100%; border-radius:12px; margin-bottom:10px; }
.place-item strong { color:var(--gold); font-size:16px; }
.place-item p { font-size:13px; margin:6px 0; color:#444; }
.label { color:var(--gold); font-weight:800; font-size:13px; margin-top:6px; }

/* Carte */
#map { flex:1; height:100vh; position:relative; z-index:100; }

/* Logo */
.logo {
  position:absolute; top:18px; left:50%;
  transform:translateX(-50%);
  z-index:1200;
}
.logo img { height:60px; }

/* UI flottante droite */
.ui-stack {
  position:absolute; top:18px; right:18px; z-index:1200;
  display:flex; flex-direction:column; gap:12px; align-items:flex-end;
}
.search-area {
  display:flex; gap:8px; align-items:center;
  background:rgba(255,255,255,0.92);
  padding:8px 14px; border-radius:999px; box-shadow: var(--shadow);
  backdrop-filter:blur(6px);
}
.search-area input {
  padding:8px 14px; border:none; outline:none;
  border-radius:999px; background:#f0f0f0; min-width:260px;
}
.search-area button {
  padding:8px 16px; border:none; border-radius:999px;
  background:var(--gold); color:#fff; font-weight:700; cursor:pointer;
}
.search-area button:hover { background:#b18e1e; }

/* Bulle questions */
.qa-card {
  position:relative;
  background:rgba(255,255,255,0.92); box-shadow: var(--shadow);
  border:1px solid #eee; border-radius:16px; padding:12px 16px; max-width:360px;
  backdrop-filter:blur(6px);
  font-size:14px; line-height:1.4; color:#333;
}
.qa-card b { color:var(--gold); }
.qa-card a {
  color:var(--gold); font-weight:800;
  text-decoration:none; border-bottom:1px dashed var(--gold);
}
.qa-close {
  position:absolute; top:8px; right:10px;
  background:none; border:none; font-size:18px;
  cursor:pointer; color:#666; font-weight:bold;
}

/* Boutons bas droite */
.fab-group {
  position:absolute; bottom:20px; right:20px;
  z-index:1200; display:flex; flex-direction:column; gap:12px;
}
.fab {
  background:var(--gold); color:#fff; border:none;
  padding:12px 18px; border-radius:999px; box-shadow: var(--shadow);
  cursor:pointer; font-weight:800; font-size:15px;
}
.fab:hover { background:#b18e1e; }

/* Filtres bas carte */
.bottom-filters {
  position:absolute; bottom:20px; left:50%;
  transform:translateX(-50%);
  background:rgba(255,255,255,0.9);
  border-radius:20px; padding:10px 20px;
  box-shadow: var(--shadow);
  display:flex; gap:12px; z-index:1200;
  backdrop-filter:blur(6px);
}
.bottom-filters button {
  border:1px solid var(--gold);
  background:transparent;
  color:var(--gold);
  font-weight:700; font-size:15px;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
  transition:all .2s;
}
.bottom-filters button:hover,
.bottom-filters button.active {
  background:var(--gold); color:#fff;
}

/* Popup */
.leaflet-popup-content { font-size:14px; }
.popup-photo {
  max-width:220px; border-radius:12px;
  margin-bottom:6px; box-shadow:0 2px 8px rgba(0,0,0,0.18);
}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-head">
    <h2>√âtablissements</h2>
    <button class="pill" id="top20Toggle">Top 20</button>
  </div>
  <div class="places-list" id="placesList">
    <p style="font-size:14px; color:#666;">Aucun √©tablissement labellis√©.</p>
  </div>
</aside>

<!-- Carte -->
<div id="map"></div>

<!-- Logo -->
<div class="logo"><img src="logo.png" alt="AllergoZyme"/></div>

<!-- Recherche + Bulle -->
<div class="ui-stack">
  <form class="search-area" id="searchForm">
    <input id="q" type="search" placeholder="Rechercher‚Ä¶ (nom, ville, d√©partement, pays, commentaire)"/>
    <button type="submit">OK</button>
  </form>

  <div class="qa-card" id="qaCard">
    <button class="qa-close" id="qaClose">‚úï</button>
    <div><b>Vous avez des questions en tant que consommateur&nbsp;?</b></div>
    <div>Un √©tablissement vous int√©resse ou vous souhaitez un retour&nbsp;?
      √âcrivez-nous : <a href="mailto:allergozymepro@gmail.com">allergozymepro@gmail.com</a></div>
    <div style="margin-top:6px;"><b>Vous √™tes professionnel&nbsp;?</b>
      Rejoignez le label ou posez vos questions :
      <a href="mailto:allergozymepro@gmail.com">allergozymepro@gmail.com</a></div>
  </div>
</div>

<!-- Boutons flottants -->
<div class="fab-group">
  <button class="fab" id="locateBtn">üìç Localiser</button>
</div>

<!-- Filtres bas carte -->
<div class="bottom-filters" id="bottomFilters">
  <button data-type="all" class="active">Tous</button>
  <button data-type="restaurant">Restaurant</button>
  <button data-type="boulangerie">Boulangerie</button>
  <button data-type="snack">Snack</button>
  <button data-type="bar">Bar</button>
  <button data-type="autre">Autre</button>
</div>

<script>
/* ---------- Donn√©es ---------- */
const STORAGE_KEY="allergozyme_places_v3";
let places=[];
try{ places=JSON.parse(localStorage.getItem(STORAGE_KEY))||[]; }catch{ places=[]; }

/* ---------- Carte ---------- */
const map = L.map("map", { zoomControl:true }).setView([20,0],2);
L.esri.basemapLayer("Imagery").addTo(map);
L.esri.basemapLayer("ImageryLabels").addTo(map);

/* ---------- Ic√¥ne logo ---------- */
const markerIcon=L.divIcon({
  html:`<div style="
    width:52px;height:52px;background:#fff;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    border:2px solid #c9a227; box-shadow:0 6px 16px rgba(0,0,0,0.2);
  "><img src="logo.png" style="width:30px;height:30px;"/></div>`,
  iconSize:[52,52], className:""
});

let markers=[]; let showTop20Only=false; let typeFilter="all";

/* ---------- Utilitaires ---------- */
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
function escapeHTML(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function haversine(lat1,lon1,lat2,lon2){
  const toRad=v=>(v*Math.PI)/180; const R=6371;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ---------- Rendu ---------- */
function addPlaceToSidebar(p,isTop){
  const sidebar=document.getElementById("placesList");
  const div=document.createElement("div");
  div.className="place-item";
  div.innerHTML=`
    ${p.photos&&p.photos[0]?`<img src="${p.photos[0]}" alt="">`:""}
    <strong>${escapeHTML(p.nom)}</strong>
    <p>${escapeHTML(p.commentaire||"")}</p>
    ${isTop?`<div class="label">Labellis√© par AllergoZyme</div>`:""}
  `;
  div.onclick=()=>{
    map.setView([p.lat,p.lng],16);
    const mk=markers.find(mk=>{
      const c=mk.getLatLng();
      return Math.abs(c.lat-p.lat)<1e-9 && Math.abs(c.lng-p.lng)<1e-9;
    });
    if(mk) mk.openPopup();
  };
  sidebar.appendChild(div);
}

function render(list){
  clearMarkers();
  const sidebar=document.getElementById("placesList");
  sidebar.innerHTML="";
  const visible=list.filter(p=>p.show);

  let filtered=visible;
  if(showTop20Only) filtered=filtered.filter(p=>p.top20);
  if(typeFilter!=="all") filtered=filtered.filter(p=>(p.type||"").toLowerCase()===typeFilter);

  if(!filtered.length){
    sidebar.innerHTML="<p style='font-size:14px; color:#666;'>Aucun √©tablissement labellis√©.</p>";
    return;
  }

  const top=filtered.filter(p=>p.top20);
  const others=filtered.filter(p=>!p.top20);

  function addMarkerAndCard(p,isTop){
    const m=L.marker([p.lat,p.lng],{icon:markerIcon}).addTo(map);
    const photo=p.photos&&p.photos[0]?`<img src="${p.photos[0]}" class="popup-photo"/>`:"";
    m.bindPopup(`${photo}<b>${escapeHTML(p.nom)}</b><br/>${escapeHTML(p.commentaire||"")}`);
    markers.push(m);
    addPlaceToSidebar(p,isTop);
  }
  top.forEach(p=>addMarkerAndCard(p,true));
  others.forEach(p=>addMarkerAndCard(p,false));
}
render(places);

/* ---------- Recherche intelligente ---------- */
document.getElementById("searchForm").addEventListener("submit",e=>{
  e.preventDefault();
  const q=document.getElementById("q").value.trim().toLowerCase();
  if(!q){ render(places); return; }
  const filtered=places.filter(p=>{
    const hay=[p.nom,p.commentaire,p.ville,p.departement,p.pays]
      .map(v=>(v||"").toString().toLowerCase()).join(" ");
    return hay.includes(q);
  });
  render(filtered);
});

/* ---------- Top20 toggle ---------- */
document.getElementById("top20Toggle").addEventListener("click",()=>{
  showTop20Only=!showTop20Only;
  document.getElementById("top20Toggle").classList.toggle("on",showTop20Only);
  render(places);
});

/* ---------- Bulle questions : fermer ---------- */
document.getElementById("qaClose").addEventListener("click",()=>{
  document.getElementById("qaCard").style.display="none";
});

/* ---------- Localisation + Top20 proches ---------- */
document.getElementById("locateBtn").addEventListener("click",()=>{
  if(!navigator.geolocation){
    alert("G√©olocalisation non support√©e.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const user={lat:pos.coords.latitude,lng:pos.coords.longitude};
    map.setView([user.lat,user.lng],14);
    L.circle([user.lat,user.lng],{
      radius:250,color:"#c9a227",fillColor:"#c9a227",fillOpacity:0.25
    }).addTo(map);

    const nearbyTop=places.filter(p=>p.show&&p.top20)
      .map(p=>({p,d:haversine(user.lat,user.lng,p.lat,p.lng)}))
      .filter(x=>x.d<=30).sort((a,b)=>a.d-b.d).map(x=>x.p);

    if(nearbyTop.length){
      showTop20Only=true;
      document.getElementById("top20Toggle").classList.add("on");
      render(nearbyTop);
    }else{
      showTop20Only=false;
      document.getElementById("top20Toggle").classList.remove("on");
      render(places);
    }
  },()=>{ alert("Impossible de r√©cup√©rer la position."); },
  {enableHighAccuracy:true,timeout:12000,maximumAge:0});
});

/* ---------- Filtres bas carte ---------- */
document.querySelectorAll("#bottomFilters button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("#bottomFilters button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    typeFilter=btn.dataset.type;
    render(places);
  });
});
</script>
</body>
</html>
